<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>D3 Page Template</title>
  <script type="text/javascript" src="../d3/d3.js"></script>
  <link rel="stylesheet" type="text/css" href="../styles/style.css">
</head>

<body id="waffleBody">
<h1>D3 Prototype of Waffle Chart</h1>

  <h3>The below graphic shows summed data for all titles held between the pub years 2005-2001.</h3>

<div id="title">
  <p>Tesing utility for Group Collection Overview Page</p>
  </div>
<div id="waffle">
</div>
<div id="legend">
</div>
<div id="squareLegend">
</div>
</body>




<script>

var total = 0;
var width,
    height,
    widthSquares = 50,
    heightSquares = 25,
    squareSize = 15,
    squareValue = 0,
    gap = 1,
    theData = [];  

var color = d3.scale.category20();

var dataset;

d3.csv("../data/pub-years.csv", function(error, data) {
  dataset = data;
  //total
  total = d3.sum(data, function(d) { return d.years; });

  //value of a square
  squareValue = total / (widthSquares*heightSquares);
  
  //remap data
  data.forEach(function(d, i) 
  {
      d.years = +d.years;
      d.units = Math.floor(d.years/squareValue);
      theData = theData.concat(
        Array(d.units+1).join(1).split('').map(function()
          {
            return {  squareValue:squareValue,                      
                      units: d.units,
                      years: d.years,
                      groupIndex: i};
          })
        );
  });

  width = (squareSize*widthSquares) + widthSquares*gap + 25;
  height = (squareSize*heightSquares) + heightSquares*gap + 25;

  var waffle = d3.select("#waffle")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .selectAll("div")
      .data(theData)
      .enter()
      .append("rect")
      .attr("width", squareSize)
      .attr("height", squareSize)
      .attr("fill", function(d)
      {
        return color(d.groupIndex);
      })
      .attr("x", function(d, i)
        {
          //group n squares for column
          col = Math.floor(i/heightSquares);
          return (col*squareSize) + (col*gap);
        })
      .attr("y", function(d, i)
      {
        row = i%heightSquares;
        return (heightSquares*squareSize) - ((row*squareSize) + (row*gap))
      })
      .append("title")
        .text(function (d,i) 
          {
            return "Years between 2005-2001: " + data[d.groupIndex].name + " | " +  d.years + " , " + d.units + "%"
          });

   //add legend with categorical data
   var legend = d3.select("#legend")
    .append("svg")
    .attr('width', 800)
    .attr('height', 500)
    .append('g')
    .selectAll("div")
    .data(data)
    .enter()
      .append("g")
      .attr('transform', function(d,i){ return "translate(0," + i*20 + ")";});
  legend.append("rect")
    .attr("width", 18)
    .attr("height", 18)
    .style("fill", function(d, i) { return color(i)});
  legend.append("text")
    .attr("x", 25)
    .attr("y", 13)
    .text( function(d) { return d.name});

    //add value of a unit square
    var totalLegend = d3.select("#legend")
      .select('svg')
      .append('g')
      .attr('transform', "translate(100,0)");

    totalLegend.append("text")    
      .attr('x', '60')  
      .attr('y', '15')     
      .attr('font-size', '18px')
      .text("Each Square: " + squareValue + "  Total: " + total)
      .attr("fill", "#444444");

});

</script>
</html>